<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PuppyCloud • Peers</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
    header { padding: 16px 20px; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: color-mix(in oklab, Canvas 96%, transparent); backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    header h1 a { color: inherit; text-decoration: none; border-radius: 8px; padding: 4px 6px; display: inline-block; }
    header h1 a:hover { background: color-mix(in oklab, Canvas 92%, transparent); }
    header nav { display:flex; gap:14px; }
    header nav a { color: inherit; text-decoration: none; padding: 8px 10px; border-radius: 8px; }
    header nav a:hover { background: color-mix(in oklab, Canvas 92%, transparent); }
    main { padding: 20px; max-width: 900px; margin: 0 auto; }
    h1 { margin: 0; font-size: 1.4rem; }
    section { margin: 20px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid #eee; font-variant-numeric: tabular-nums; }
    .muted { color: #666; font-size: .92rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace; }
    .card { background: color-mix(in oklab, Canvas 98%, transparent); }
    .qr-modal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .qr-modal.open { display: flex; }
    .qr-box { width: min(92vw, 520px); background: color-mix(in oklab, Canvas 98%, transparent); border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px; }

    /* Prevent overflow in peers table */
    .table-wrap { overflow-x: auto; }
    table { table-layout: fixed; }
    th:nth-child(1), td:nth-child(1) { width: 38%; }
    th:nth-child(2), td:nth-child(2) { width: 42%; }
    th:nth-child(3), td:nth-child(3) { width: 20%; white-space: nowrap; }
    td.mono { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
<header>
  <h1><a href="/">PuppyCloud</a></h1>
  <nav aria-label="Primary">
    <a href="/peers" aria-current="page">Peers</a>
    <a href="/gallery">Gallery</a>
  </nav>
</header>
<main>
  <section class="card">
    <h2>Known peers</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Peer ID</th><th>Last Address</th><th>Last Seen</th></tr>
        </thead>
        <tbody id="peers"></tbody>
      </table>
    </div>
    <div class="muted">Up to 100 most recent entries.</div>
  </section>

  <section class="card">
    <h2>Connect to peer</h2>
    <div class="row">
      <input id="addr" type="text" placeholder="/ip4/127.0.0.1/tcp/4001/p2p/12D3KooW…" />
      <input id="pwd" type="text" placeholder="Password" style="max-width:120px" />
      <button id="dialBtn" onclick="dial()">Dial</button>
      <button id="scanBtn" onclick="openQRScanner()">Scan QR</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px"></div>
  </section>
</main>

<div id="qrModal" class="qr-modal" onclick="closeQRScanner()" aria-hidden="true" role="dialog">
  <div class="qr-box" onclick="event.stopPropagation()">
    <h3>Scan QR code</h3>
    <video id="qrVideo" playsinline autoplay muted style="width:100%; border-radius:8px; background:#000; aspect-ratio:3/4; object-fit:cover;"></video>
    <canvas id="qrCanvas" hidden></canvas>
    <div class="row" style="margin-top:10px; justify-content:flex-end;">
      <button onclick="closeQRScanner()">Cancel</button>
    </div>
    <div id="qrError" class="muted"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
async function loadPeers(){
  try{
    const r = await fetch('/p2p/peers');
    const j = await r.json();
    const tb = document.getElementById('peers');
    tb.innerHTML = '';
    for(const p of j){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = p.peer_id; td1.className='mono'; td1.title = p.peer_id;
      const td2 = document.createElement('td'); td2.textContent = p.last_addr || ''; td2.className='mono'; td2.title = p.last_addr || '';
      const td3 = document.createElement('td'); td3.textContent = new Date(p.last_seen * 1000).toLocaleString();
      tr.append(td1, td2, td3); tb.appendChild(tr);
    }
  }catch(e){ console.error(e); }
}
async function dial(){
  const btn = document.getElementById('dialBtn');
  const status = document.getElementById('status');
  const addr = document.getElementById('addr').value.trim();
  const pwd = document.getElementById('pwd').value.trim();
  if(!addr){ status.textContent = 'Enter a multiaddr'; return; }
  btn.disabled = true; status.textContent = 'Dialing…';
  try{
    const r = await fetch('/p2p/dial', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ addr, password: pwd })});
    const j = await r.json();
    status.textContent = 'Dialed: ' + j.addr;
  }catch(e){ status.textContent = 'Error: ' + e; }
  btn.disabled = false;
}
let qrStream = null;
let qrRaf = null;
function openQRScanner(){
  const modal = document.getElementById('qrModal');
  const video = document.getElementById('qrVideo');
  const err = document.getElementById('qrError');
  err.textContent = '';
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    err.textContent = 'Camera not supported in this browser.';
    modal.classList.add('open');
    return;
  }
  if(!window.jsQR){ err.textContent = 'QR decoder not loaded. Check network connection.'; }
  modal.classList.add('open');
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false })
    .then(stream => { qrStream = stream; video.srcObject = stream; return video.play(); })
    .then(() => { scanLoop(); })
    .catch(e => { err.textContent = 'Camera error: ' + e; });
}
function scanLoop(){
  const video = document.getElementById('qrVideo');
  const canvas = document.getElementById('qrCanvas');
  const err = document.getElementById('qrError');
  const w = video.videoWidth|0, h = video.videoHeight|0;
  if(w > 0 && h > 0){
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    const img = ctx.getImageData(0, 0, w, h);
    try{
      const code = window.jsQR && jsQR(img.data, w, h, { inversionAttempts: 'dontInvert' });
      if(code && code.data){ handleQRResult(code.data.trim()); return; }
    }catch(e){ err.textContent = 'Decode error: ' + e; }
  }
  qrRaf = requestAnimationFrame(scanLoop);
}
function handleQRResult(text){
  try{
    const obj = JSON.parse(text);
    if(obj.expires && Date.now() > obj.expires * 1000){
      alert('Invite expired');
      closeQRScanner();
      return;
    }
    document.getElementById('addr').value = obj.addr || '';
    document.getElementById('pwd').value = obj.password || '';
  }catch{
    document.getElementById('addr').value = text;
  }
  closeQRScanner();
  dial();
}
function closeQRScanner(){
  const modal = document.getElementById('qrModal');
  modal.classList.remove('open');
  if(qrRaf){ cancelAnimationFrame(qrRaf); qrRaf = null; }
  const video = document.getElementById('qrVideo');
  if(video){ try{ video.pause(); }catch(_){} }
  if(qrStream){ qrStream.getTracks().forEach(t => t.stop()); qrStream = null; }
}
window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeQRScanner(); });
window.addEventListener('load', loadPeers);
</script>
</body>
</html>
