<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PuppyCloud</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
    header { padding: 16px 20px; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: color-mix(in oklab, Canvas 96%, transparent); backdrop-filter: blur(6px); }
    main { padding: 20px; max-width: 900px; margin: 0 auto; }
    h1 { margin: 0; font-size: 1.4rem; }
    section { margin: 20px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 12px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type=text] { padding: 10px 12px; border: 1px solid #ccc; border-radius: 8px; min-width: 280px; flex: 1; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; background: #4f46e5; color: white; cursor: pointer; }
    button:disabled { background: #a8a29e; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid #eee; font-variant-numeric: tabular-nums; }
    .muted { color: #666; font-size: .92rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace; }
    .chip { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: .85rem; }
    .card { background: color-mix(in oklab, Canvas 98%, transparent); }
  </style>
</head>
<body>
<header>
  <h1>PuppyCloud</h1>
</header>
<main>
  <section class="card">
    <h2>This node</h2>
    <div class="muted">Peer ID:</div>
    <div id="peerId" class="mono" style="word-break: break-all;">…</div>
    <div class="muted" style="margin-top:10px">Listening addresses:</div>
    <ul id="addrs" class="mono"></ul>
  </section>

  <section class="card">
    <h2>Known peers</h2>
    <table>
      <thead>
        <tr><th>Peer ID</th><th>Last Address</th><th>Last Seen</th></tr>
      </thead>
      <tbody id="peers"></tbody>
    </table>
    <div class="muted">Up to 100 most recent entries.</div>
  </section>

  <section class="card">
    <h2>Connect to peer</h2>
    <div class="row">
      <input id="addr" type="text" placeholder="/ip4/127.0.0.1/tcp/4001/p2p/12D3KooW…" />
      <button id="dialBtn" onclick="dial()">Dial</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px"></div>
  </section>
</main>
<script>
async function loadInfo(){
  try{
    const r = await fetch('/p2p/info');
    const j = await r.json();
    document.getElementById('peerId').textContent = j.peer_id;
    const ul = document.getElementById('addrs');
    ul.innerHTML = '';
    j.addrs.forEach(a => { const li = document.createElement('li'); li.textContent = a; ul.appendChild(li); });
  }catch(e){ console.error(e); }
}
async function loadPeers(){
  try{
    const r = await fetch('/p2p/peers');
    const j = await r.json();
    const tb = document.getElementById('peers');
    tb.innerHTML = '';
    for(const p of j){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = p.peer_id; td1.className='mono';
      const td2 = document.createElement('td'); td2.textContent = p.last_addr || ''; td2.className='mono';
      const td3 = document.createElement('td'); td3.textContent = new Date(p.last_seen * 1000).toLocaleString();
      tr.append(td1, td2, td3); tb.appendChild(tr);
    }
  }catch(e){ console.error(e); }
}
async function dial(){
  const btn = document.getElementById('dialBtn');
  const status = document.getElementById('status');
  const addr = document.getElementById('addr').value.trim();
  if(!addr){ status.textContent = 'Enter a multiaddr'; return; }
  btn.disabled = true; status.textContent = 'Dialing…';
  try{
    const r = await fetch('/p2p/dial', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ addr })});
    const j = await r.json();
    status.textContent = 'Dialed: ' + j.addr;
  }catch(e){ status.textContent = 'Error: ' + e; }
  btn.disabled = false;
}
window.addEventListener('load', ()=>{ loadInfo(); loadPeers(); });
</script>
</body>
</html>
